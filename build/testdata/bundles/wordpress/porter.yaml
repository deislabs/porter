mixins:
- exec
- helm

name: wordpress
version: 0.1.0
invocationImage: porter-wordpress:latest
tag: deislabs/porter-wordpress-bundle:v0.1.0

dependencies:
- name: mysql
  parameters:
    database-name: wordpress
    mysql-user: wordpress

credentials:
- name: kubeconfig
  path: /root/.kube/config

parameters:
- name: wordpress-name
  type: string
  default: porter-ci-wordpress
  destination:
    env: WORDPRESS_NAME
- name: wordpress-password
  type: string
  sensitive: true
- name: mysql-password
  type: string
  default: insecure-db-password
  sensitive: true
- name: namespace
  type: string
  default: ''

install:
  - helm:
      description: "Install Wordpress"
      name: "{{bundle.parameters.wordpress-name }}"
      chart: stable/wordpress
      namespace: "{{ bundle.parameters.namespace }}"
      replace: true
      set:
        wordpressPassword: "{{ bundle.parameters.wordpress-password }}"
        externalDatabase.database: "{{ bundle.dependencies.mysql.parameters.database-name }}"
        #externalDatabase.host: "{{ bundle.dependencies.mysql.outputs.services }}"
        externalDatabase.user: "{{ bundle.dependencies.mysql.parameters.mysql-user }}"
        externalDatabase.password: "{{ bundle.parameters.mysql-password }}"
        externalDatabase.port: 3306
        mariadb.enabled: false
      outputs:
        - name: wordpress-password
          secret: "{{ bundle.parameters.wordpress-name }}-wordpress"
          key: wordpress-password
        - name: mysql-password
          secret: "{{ bundle.parameters.wordpress-name }}-externaldb"
          key: db-password

uninstall:
  - helm:
      description: "Uninstall Wordpress"
      purge: true
      releases: 
        - "{{ bundle.parameters.wordpress-name }}"

outputs:
  - name: wordpress-password
    description: "The Wordpress installation password"
    type: string
    applyTo:
      - "install"
      - "upgrade"
  - name: mysql-password
    description: "The MySQL DB password"
    type: string
    applyTo:
      - "install"
      - "upgrade"