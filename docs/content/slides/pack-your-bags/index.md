---
title: "Pack Your Bags: Managing Distributed Applications with CNAB"
description: |
  Learn how to use Cloud Native Application Bundles (CNAB) and Porter to bundle up your
  application and its infrastructure so that it is easier to manage.
url: "/pack-your-bags/"
---
class: center, middle

# Pack your bags
##  Managing Distributed Applications with CNAB

---
name: setup

# Workshop Setup

It can take a while for things to download and install over the workshop wifi,
so please go to the workshop materials directory and follow the setup instructions
to get all the materials ready.

.center[üë©üèΩ‚Äç‚úàÔ∏è https://porter.sh/pack-your-bags/#setup üë©üèΩ‚Äç‚úàÔ∏è ]

* Clone the workshop repository
  ```
  git clone https://github.com/deislabs/porter.git
  cd porter/workshop
  ```
* [Install Porter](https://porter.sh/install)
* Create a Kubernetes Cluster on [macOS](https://docs.docker.com/docker-for-mac/kubernetes/) or [Windows](https://docs.docker.com/docker-for-windows/kubernetes/)
* [Install Helm 2](https://helm.sh/docs/install/)
* Initialize Helm on your cluster by running `helm init`


---
name: agenda

# Agenda

1. What is CNAB?
2. Manage Bundles with Porter
3. Authoring Bundles

---
name: introductions

# Introductions

<div id="introductions">
  <div class="left">
    <img src="/images/carolynvs.jpg" width="150px" />
    <p>Carolyn Van Slyck</p>
    <p>Senior Software Engineer</p>
    <p>Microsoft Azure</p>
  </div>
  <div class="right">
    <img src="/images/jerrycar.jpg" width="200px" />
    <p>Jeremy Rickard</p>
    <p>Senior Software Engineer</p>
    <p>Microsoft Azure</p>
  </div>
</div>

---
name: cnab

# What is CNAB?

Quick demo of 2 min demo of porter doing a porter install (azure + helm)
Runs while we talk (azure-mysql-wordpress or a quickstart from Brian)

Break up our talk 1-20 + 23

???
Explain why a spec is necessary

---
name: sharing

# Sharing Bundles

OCI (docker) Registries
Slide 22

---
name: anatomy

# Anatomy of a Bundle

Slide 21 from our talk

---
# CNAB Specification

* bundle format
* run entrypoint
* well-defined install/uninstall verbs
* passing data into a bundle

---
# Breakdown of Azure MySQL Wordpress

---
class: center, middle

# BREAK

---
class: center, middle

# Manage Bundles with Porter

.center[
  üö® Not Setup Yet? üö®

  https://porter.sh/pack-your-bags/#setup
  
  ]
---
name: hello
class: center

# Tutorial
# Hello World

.center[
  ![whale saying hello](/images/whale-hello.png)
]
---

## porter create

```console
$ porter create --help
Create a bundle. This generates a porter bundle in the current directory.
```

---

### porter.yaml
**The most important file**.  Edit and check this in. Everything else is optional.

### README.md
Explains the other files in detail

### Dockerfile.tmpl
Optional template for your bundle's invocation image

### .gitignore
Suggested set of files to ignore in git

### .dockerignore
Suggested set of files to not include in your bundle

---

# porter.yaml

```yaml
mixins:
  - exec

name: HELLO
version: 0.1.0
description: "An example Porter configuration"
invocationImage: porter-hello:latest

install:
  - exec:
      description: "Install Hello World"
      command: bash
      arguments:
        - -c
        - echo Hello World
```

---

## Try it out: porter create

```console
$ mkdir hello
$ porter create
creating porter configuration in the current directory
$ ls
Dockerfile.tmpl  README.md  porter.yaml
```

---

## porter build

```console
$ porter build --help
Builds the bundle in the current directory by generating a Dockerfile 
and a CNAB bundle.json, and then building the invocation image.
```

---

## Try it out: porter build

```console
$ porter build

Copying dependencies ===>
Copying porter runtime ===>
Copying mixins ===>
Copying mixin exec ===>
Generating Dockerfile =======>
Writing Dockerfile =======>
Starting Invocation Image Build =======>
Generating Bundle File with Invocation Image porter-hello:latest =======>
Generating parameter definition porter-debug ====>
```

---

# What did Porter do? üîé

---
### Dockerfile
```Dockerfile
FROM quay.io/deis/lightweight-docker-go:v0.2.0
FROM debian:stretch
COPY --from=0 /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/ca-certificates.crt

COPY . /cnab/app
RUN mv /cnab/app/cnab/app/* /cnab/app && rm -r /cnab/app/cnab
# exec mixin has no buildtime dependencies
```
.footnote[üö® Generated by Porter]

---

### cnab/
```console
$ tree cnab/
cnab
‚îú‚îÄ‚îÄ app
‚îÇ   ‚îú‚îÄ‚îÄ mixins
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ exec
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ exec
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ exec-runtime
‚îÇ   ‚îú‚îÄ‚îÄ porter-runtime
‚îÇ   ‚îî‚îÄ‚îÄ run
‚îî‚îÄ‚îÄ bundle.json
```

### cnab/app/run

```bash
#!/usr/bin/env bash
exec /cnab/app/porter-runtime run -f /cnab/app/porter.yaml
```
.footnote[üö® Generated by Porter]

---

### bundle.json
```json
{
    "description": "An example Porter configuration",
    "invocationImages": [
        {
            "image": "porter-hello:latest",
            "imageType": "docker"
        }
    ],
    "name": "HELLO",
    "parameters": {
        "porter-debug": {
            "destination": {
                "env": "PORTER_DEBUG"
            },
            "metadata": {
                "description": "Print debug information from Porter when executing the bundle"
            },
            "type": "bool"
        }
    },
    "version": "0.1.0"
}
```
.footnote[üö® Generated by Porter]

---

## porter install

```console
$ porter install --help
Install a bundle.

The first argument is the name of the claim to create for the installation. 
The claim name defaults to the name of the bundle.

Flags:
  -c, --cred strings         Credential to use when installing the bundle. 
  -f, --file string          Path to the bundle file to install.
      --param strings        Define an individual parameter in the form NAME=VALUE.
      --param-file strings   Path to a parameters definition file for the bundle
```

---
## CNAB: What Executes Where

TODO PICTURE

---

## Try it out: porter install

```console
$ porter install

installing HELLO...
executing porter install configuration from /cnab/app/porter.yaml
Install Hello World
Hello World
execution completed successfully!
```

---
name: mellamo
class: center

# Tutorial
# Hi, My Name is _

.center[
  ![como se llamo me llamo llama](/images/me-llamo.jpg)
]

---
name: parameters

## Parameters

Variables in your bundle that you can specify when you execute the bundle
and are loaded into the bundle either as environment variables or files.

### Define a Paramer
```yaml
parameters:
- name: name
  type: string
  default: llama
```

### Use a Parameter
```yaml
- "echo Hello, {{ bundle.parameters.name }}"
```

* Needs double quotes around the yaml entry
* Needs double curly braces around the templating
* Uses the format `bundle.parameters.PARAMETER_NAME`

???
Explain defaults and when parameters are required

---

## Try it out: Print Your Name

Modify the hello bundle to print "Hello, YOUR NAME", for example "Hello, Aarti", using a parameter.

1. Edit the porter.yaml to define a parameter named `name`.
1. Use the parameter in the `install` action and echo your name.
1. Rebuild your bundle with `porter build`.
1. Finally run `porter install -p name=YOUR_NAME` and look for your name in the output.

---

### porter bundle list

```console
$ porter bundle list
NAME          CREATED         MODIFIED        LAST ACTION   LAST STATUS
HELLO_LLAMA   5 seconds ago   3 seconds ago   install       success
HELLO         8 minutes ago   8 minutes ago   install       success
```

???
Ask them to list their bundles

---
name: claims

### Claims

Claims are records of any actions performed by CNAB compliant tools on a bundle.

```console
$ cat ~/.porter/claims/HELLO.json
{
  "name": "HELLO",
  "revision": "01DCFCN6AH00SM8E1968XHTSJ5",
  "created": "2019-06-03T14:22:00.952704-05:00",
  "modified": "2019-06-03T14:22:02.449355-05:00",
  "result": {
    "message": "",
    "action": "install",
    "status": "success"
  },
  "parameters": {
    "porter-debug": false,
    "name": "llama"
  },
  ...
}
```

---
name: cleanup-hello
## Cleanup Hello World

First run `porter uninstall` without any arguments:
```console
$ porter uninstall
uninstalling HELLO...
executing porter uninstall configuration from /cnab/app/porter.yaml
Uninstall Hello World
Goodbye World
execution completed successfully!
```

Now run `porter uninstall` with the name you used for the modified bundle:
```console
$ porter uninstall HELLO_LLAMA
uninstalling HELLO_LLAMA...
executing porter uninstall configuration from /cnab/app/porter.yaml
Uninstall Hello llama
Goodbye llama
execution completed successfully!
```

---
name: wordpress
class: center

# Tutorial
# Wordpress

---
name: credentials

## Credentials

Variables that can be specified when the bundle is executed that are _associated with the identity 
of the user executing the bundle_, and are loaded into the bundle either as environment variables or files.

They are mapped from the local system using named credential sets, instead of specified on the command-line.

---
name: creds-v-params
## Credentials vs. Parameters

### Parameters
* Application Configuration
* Stored in the claim
* üö® Available in **plaintext** on the local filesystem

### Credentials
* Identity of the user executing the bundle
* Is not stored in the claim
* Has to be presented every time you perform an action

---
name: passwords

## Credentials, Passwords and Sensitive Data

* Credentials are for data identifying data associated with a user. They are 
re-specified every time you run a bundle, and are not stored in the claim.
* Parameters can store sensitive data using the `sensitive` flag. This prevents 
the value from being printed to the console.
* We (porter) and the CNAB spec are working on more robust storage mechanisms for 
claims with sensitive data, and better ways to pull data from secret stores so that 
they don't end up on the file system unencrypted.

In all honesty this area is a work in progress. I would shove as everything in a 
credential for now but be aware of the distinction and where the CNAB spec is moving.

---
## porter credentials generate

```console
$ porter credentials generate --help
Generate a named set of credentials.

The first argument is the name of credential set you wish to generate. If not
provided, this will default to the bundle name. By default, Porter will
generate a credential set for the bundle in the current directory. You may also
specify a bundle with --file.

Bundles define 1 or more credential(s) that are required to interact with a
bundle. The bundle definition defines where the credential should be delivered
to the bundle, i.e. at /root/.kube. A credential set, on the other hand,
represents the source data that you wish to use when interacting with the
bundle. These will typically be environment variables or files on your local
file system.

When you wish to install, upgrade or delete a bundle, Porter will use the
credential set to determine where to read the necessary information from and
will then provide it to the bundle in the correct location.
```

---
## Wordpress Credential Mapping

### ~/.porter/credentials/wordpress.yaml
```yaml
name: wordpress
credentials:
- name: kubeconfig
  source:
    path: /Users/carolynvs/.kube/config
```

### porter.yaml
```yaml
credentials:
- name: kubeconfig
  path: /root/.kube/config
```

---
## Try it out: porter credentials generate

Generate a set of credentials for the wordpress bundle in this repository.

1. Change to the `wordpress` directory under the workshop materials
1. Run `porter credentials generate` and follow the interactive prompts to create a set of credentials
for the wordpress bundle.

???
we all do this together

---
## Try it out: porter install --cred

Install the wordpress bundle and pass it the named set of credentials that you generated.

```console
$ porter install --cred wordpress
```

---
name: cleanup-wordpress

## Cleanup Wordpress

```console
$ porter uninstall --cred wordpress
```

???
Explain why --cred is required again for uninstall 

---
class: center, middle

# BREAK

---
name: author
class: center, middle

# Authoring Bundles

---
name: manifest
# Porter Manifest In-Depth

---
## Metadata

```yaml
name: "azure-wordpress"
version: "v0.1.0"
invocationImage: "deislabs/azure-wordpress-ii:v0.1.0"
tag: "deislabs/azure-wordpress:v0.1.0"
```

---
## Mixins

Declare any mixins that you are going to use

```yaml
mixins:
  - azure
  - helm
```

---
## Parameters

Define parameters that the bundle requires.

```yaml
parameters:
- name: mysql_user
  type: string
  default: wordpress
- name: mysql_password
  type: string
  sensitive: true
```

---
## Credentials

Define credentials that the bundle requires and where they should be placed
in the bundle when it is executing:

* environment variables (env)
* files (path)

```yaml
credentials:
- name: SUBSCRIPTION_ID
  env: AZURE_SUBSCRIPTION_ID
- name: kubeconfig
  path: /root/.kube/config
```

---
## Custom Dockerfile

Specify a custom Dockerfile for the invocation image

* Use a different base image
* Add users, tweak the environment and configuration
* Install tools and applications

```yaml
dockerfile: Dockerfile.tmpl
```

---
## Review: Default Dockerfile

* Uses Debian for the base image
* Installs root ssl certificates
* Copies everything in the local bundle directory into the invocation image 
  in the same directory as your bundle for you automatically

---
# Actions and Steps

---
## Actions

Actions map to the verbs you use when you use Porter.

* porter install
* porter upgrade
* porter uninstall

These are defined in the CNAB specification.

---
## Steps

Within an action you can define a series of ordered steps.

* A step must complete successfully before the next step is executed.
* A step is defined using a mixin. Each step can use only one mixin. So far we have
used the `exec` mixin that lets you run commands.
* Mixins must be declared ahead of time in the `mixins` section of the manifest.

---

```yaml
install: # action
  - exec: # step
      description: "Install my application"
      command: bash
      arguments:
        - install-myapp.sh
```

---
### Referencing files from the Manifest

We recommend referencing files using relative paths

```console
$ tree
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ porter.yaml
‚îî‚îÄ‚îÄ scripts
*    ‚îî‚îÄ‚îÄ do-things.sh
```

**porter.yaml**
```yaml
install:
  - exec:
      description: Do Things
      command: bash
      arguments:
*        - scripts/do-things.sh
```


---
## Step Outputs

* You tell the mixin what data to extract and put into an ouput
* Each mixin output will look different, but they all require a `name`
* Porter stores the output value, making it available to later steps
* Not all mixins support outputs

---
### Helm Mixin Output

```yaml
install:
- helm:
    ...
    outputs:
    - name: mysql-password
      secret: mydb
      key: mysql-password
```

---
### Kubernetes Mixin Output

```yaml
install:
  - kubernetes:
      description: "Create NGINX Deployment"
      manifests:
        - manifests/nginx
      wait: true
      outputs:
        - name: "IP_ADDRESS"
          resourceType: service
          resourceName: nginx-deployment
          jsonPath: "{.spec.clusterIP}"
```

---
name: wiring

## Hot Wiring the Manifest

These variables are available for you to use in the manifest:

* bundle.name
* bundle.parameters.PARAMETER_NAME
* bundle.credentials.CREDENTIAL_NAME
* bundle.outputs.OUTPUT_NAME

---
name: templating

## Templating

Porter uses a template engine to substitute values into the manifest.

* Needs double quotes around the yaml entry
* Use double curly braces around the templated value

**Example**
```yaml
connectionString: "{{bundle.outputs.host}}:{{bundle.outputs.port}}"
```

---
name: mixins
class: center, middle

# Mixins

_"Mixins are the lifeblood of Porter._

_They adapt between CNAB and existing tools. Porter is just glue."_

---
## Mixins Available Today

* exec
* kubernetes
* helm
* azure
* terraform

---
## Installing Mixins

Anyone can make a mixin and have people install it using Porter

**porter mixin install terraform --feed-url cdn.deislabs.io/porter/atom.xml**

---

## What if I need a mixin that doesn't exist? üò∞

You can always use a custom dockerfile to install the tool you need and then
execute the commands with the exec mixin.

Custom mixins are just easier to use, but aren't necessary.

---
# Make Your Own Mixin

---
## What makes a mixin?

* Executable written in any language
* Communicates to Porter on stdin and stdout
* Supports a few commands: build, schema, install, upgrade, uninstall
* Translates the steps from the porter manifest to commands against any external tool or service

---
## What mixin would you make?

* Docker
* Google Cloud
* CloudFormation
* AWS
* Artifactory
* Vault
* Dominos üçï
* What else?

---
class: center, middle

# CNAB Best Practices

---
# What would you really put into a bundle?

---
# What does a real bundle look like?

???
Look at the azure examples and quick starts

---
# How does this fit into a CI/C pipeline?

---
class: center, middle

# Tooling

---

# CNAB Tooling Ecosystem

???
Explain where porter shines, what it is good at vs. say docker app

---

# Duffle

???
Mention duffle as a ops tool for managing bundles from multiple orgins at runtime

---
class: center, middle

# Beyond!

---

# Roadmap

???

Both CNAB and Porter for the next 3 months and rest of the year

---

# Next Steps

???
What should someone do if they are interested in CNAB for their work or personal projects?
What is the timeline for the project and how should they be thinking about beginning to incorporate it?

---

# Contribute!

---
class: center, middle

# Choose your own adventure

* Cloud + Break Glass
* Order a pizza with Porter
* Make a mixin